<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GitHub Media Uploader (stabiln√≠ verze)</title>
  <meta name="description" content="Jednoduch√© nahr√°n√≠ videa/audio do GitHubu a vytvo≈ôen√≠ p≈ôehr√°vac√≠ str√°nky. Re≈æimy: p≈ôehr√°vaƒç, prost≈ôedn√≠ Play, background video (contain/cover, loop, barva)." />
  <style>
    :root { --bg:#f6f8fb; --surface:#fff; --muted:#5b6777; --text:#0f172a; --border:#e6eaf0; --acc:#2563eb; --acc-2:#10b981; --danger:#ef4444; --radius:14px; }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:940px;margin:0 auto;padding:28px 18px 80px}
    header{display:grid;gap:6px;margin-bottom:14px} h1{font-size:24px;margin:0} p.lead{margin:0;color:var(--muted)}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 22px rgba(16,24,40,.04)} .card+.card{margin-top:14px}
    .content{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=file],input[type=color]{width:100%;background:#fff;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px}
    input[type=color]{padding:6px;height:40px}
    .modes{display:flex;gap:10px;flex-wrap:wrap}
    .radio{display:flex;align-items:center;gap:8px;background:#f7f9fc;border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    .radio input{cursor:pointer}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:0;cursor:pointer;color:#fff;background:var(--acc);padding:12px 16px;border-radius:12px;font-weight:650;box-shadow:0 8px 18px rgba(37,99,235,.18)}
    button.sec{background:#eef2ff;color:#1e293b;box-shadow:none;border:1px solid var(--border)}
    button.ghost{background:transparent;color:#1e293b;border:1px dashed var(--border);box-shadow:none}
    .status{font-size:14px;color:#334155;white-space:pre-wrap;border-top:1px dashed var(--border);padding-top:10px;margin-top:6px}
    .ok{color:var(--acc-2)} .err{color:var(--danger)}
    .list{display:grid;gap:8px}
    .item{display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .item a{color:var(--text);text-decoration:none} .item small{color:var(--muted)}
    /* Modal (PAT) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal{width:min(560px,100%);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 18px 50px rgba(16,24,40,.12);color:var(--text)}
    .modal .content{padding:18px} .modal h2{margin:0 0 8px;font-size:18px}
    .kbd{background:#eef2ff;border:1px solid var(--border);border-radius:6px;padding:1px 5px;font:12px/1.4 ui-monospace,monospace;color:#334155}
    .hint{font-size:12px;color:#475569}
    /* BG volby */
    #bgOptions{display:none;flex-direction:column;gap:10px;margin-top:10px;font-size:13px;color:#334155;background:#f7f9fc;border:1px dashed var(--border);padding:10px;border-radius:12px}
    #bgOptions .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>GitHub Media Uploader</h1>
      <p class="lead">Stabiln√≠ verze: vyber soubor ‚Üí n√°zev ‚Üí re≈æim. Vygenerovan√° str√°nka uk√°≈æe jen samotn√© video/audio.</p>
    </header>

    <section class="card"><div class="content">
      <div>
        <label>Soubor (video / audio)</label>
        <input id="file" type="file" accept="video/*,audio/*" />
      </div>
      <div style="margin-top:10px;">
        <label>N√°zev (pro str√°nku)</label>
        <input id="title" type="text" placeholder="Nap≈ô. Prvouka ‚Äì video 01" />
      </div>
      <div style="margin-top:10px;">
        <label>Re≈æim p≈ôehr√°v√°n√≠</label>
        <div class="modes" role="radiogroup" aria-label="Re≈æim p≈ôehr√°v√°n√≠">
          <label class="radio"><input type="radio" name="mode" value="controls" checked> P≈ôehr√°vaƒç s ovladaƒçi</label>
          <label class="radio"><input type="radio" name="mode" value="overlay"> Jen prost≈ôedn√≠ tlaƒç√≠tko ‚ÄûPlay‚Äú</label>
          <label class="radio"><input type="radio" name="mode" value="bg-video"> Background video (autoplay ¬∑ muted)</label>
        </div>
        <div id="bgOptions">
          <div class="row"><label><input id="bgLoop" type="checkbox" checked> Smyƒçka (loop)</label></div>
          <div class="row">
            <span class="hint">P≈ôizp≈Øsoben√≠:</span>
            <label class="radio"><input type="radio" name="bgFit" value="contain" checked> P≈ôizp≈Øsobit (bez o≈ôezu)</label>
            <label class="radio"><input type="radio" name="bgFit" value="cover"> Vyplnit (m≈Ø≈æe o≈ô√≠znout)</label>
          </div>
          <div class="row" id="bgColorWrap">
            <span class="hint">Barva pozad√≠ (pro ‚ÄûP≈ôizp≈Øsobit‚Äú):</span>
            <input id="bgColor" type="color" value="#000000" title="Barva pozad√≠ za videem" />
          </div>
        </div>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button id="go" type="button">Nahr√°t & vytvo≈ôit str√°nku</button>
        <button id="list" class="sec" type="button">Naƒç√≠st existuj√≠c√≠ str√°nky</button>
      </div>
      <div id="status" class="status" aria-live="polite"></div>
    </div></section>

    <section class="card"><div class="content">
      <h2 style="margin:0 0 8px;font-size:18px;">Existuj√≠c√≠ str√°nky</h2>
      <div id="items" class="list"></div>
    </div></section>
  </div>

  <!-- PAT modal -->
  <div id="authBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="modal"><div class="content">
      <h2 id="authTitle">P≈ôihl√°≈°en√≠ k GitHubu (PAT)</h2>
      <p class="hint">Vlo≈æ <strong>Personal Access Token</strong> s opr√°vnƒõn√≠m <span class="kbd">contents:write</span>. Ulo≈æ√≠ se jen do <em>localStorage</em> v tomto prohl√≠≈æeƒçi.</p>
      <div style="margin-top:8px;">
        <label>GitHub token (PAT)</label>
        <input id="patInput" type="password" placeholder="token zaƒç√≠naj√≠c√≠ github_pat_‚Ä¶" />
      </div>
      <div class="actions" style="margin-top:12px;">
        <button id="savePat" type="button">Ulo≈æit token</button>
        <button id="cancelPat" class="ghost" type="button">Zru≈°it</button>
      </div>
    </div></div>
  </div>

<script>
/*****  KONFIGURACE ‚Äì UPRAV TADY  *****/
const GH_OWNER   = 'vividbooks';   // ‚Üê √∫ƒçet/organizace
const GH_REPO    = 'Prvouka';    // ‚Üê c√≠lov√Ω repo
const GH_BRANCH  = 'main';         // vƒõtev
const GH_PAGES_BASE = '';          // auto: https://{owner}.github.io/{repo}/
const FOLDER_UPLOADS = 'uploads';
const FOLDER_PAGES   = 'view';
const GH_SIZE_LIMIT_MB = 90;
/**************************************/

const LS_TOKEN_KEY = 'gh_pat_media_uploader';
const $ = (id)=>document.getElementById(id);
const logBox = $("status");

function log(msg, cls=""){ logBox.innerHTML += (logBox.innerHTML?"\n":"")+`<div class="${cls}">${msg}</div>`; logBox.scrollTop=logBox.scrollHeight; }
function clearLog(){ logBox.innerHTML=""; }

function slugify(s){ return (s||"").normalize('NFKD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,80)||'soubor'; }
function kindOf(file){ if(!file) return null; if((file.type||'').startsWith('video/'))return 'video'; if((file.type||'').startsWith('audio/'))return 'audio'; const e=(file.name.split('.').pop()||'').toLowerCase(); if(['mp4','webm','ogg','mkv','mov'].includes(e))return 'video'; if(['mp3','m4a','aac','wav','ogg','oga','flac'].includes(e))return 'audio'; return null; }
function mimeOf(file){ if(file && file.type) return file.type; const e=(file?.name?.split('.').pop()||'').toLowerCase(); const map={mp4:'video/mp4',webm:'video/webm',ogg:'video/ogg',mov:'video/quicktime',mkv:'video/x-matroska',mp3:'audio/mpeg',m4a:'audio/mp4',aac:'audio/aac',wav:'audio/wav',oga:'audio/ogg',flac:'audio/flac'}; return map[e]||'application/octet-stream'; }
function nowStamp(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+'-'+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds()); }
function needToken(){ return !localStorage.getItem(LS_TOKEN_KEY); }
function token(){ return localStorage.getItem(LS_TOKEN_KEY)||''; }
function openAuth(){ $("authBackdrop").style.display='flex'; $("patInput").focus(); }
function closeAuth(){ $("authBackdrop").style.display='none'; }
async function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>{ const s=String(r.result||''); const i=s.indexOf(','); res(i>=0?s.slice(i+1):s); }; r.onerror=rej; r.readAsDataURL(file); }); }
function utf8ToB64(str){ return btoa(unescape(encodeURIComponent(str))); }
function baseUrl(){ return (GH_PAGES_BASE || `https://${GH_OWNER}.github.io/${GH_REPO}/`).replace(/\/$/,'') + '/'; }

async function ghPut({ path, contentBase64, message }){
  const url = `https://api.github.com/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO)}/contents/${path.split('/').map(encodeURIComponent).join('/')}`;
  const r = await fetch(url, { method:'PUT', headers:{ 'Accept':'application/vnd.github+json', 'Authorization':`token ${token()}`, 'Content-Type':'application/json' }, body: JSON.stringify({ message, content: contentBase64, branch: GH_BRANCH }) });
  if(!r.ok){ throw new Error(`GitHub PUT ${path} ‚Üí ${r.status}: ${await r.text()}`); }
  return r.json();
}
async function ghList({ path }){
  const url = `https://api.github.com/repos/${encodeURIComponent(GH_OWNER)}/${encodeURIComponent(GH_REPO)}/contents/${path.split('/').map(encodeURIComponent).join('/')}?ref=${encodeURIComponent(GH_BRANCH)}`;
  const r = await fetch(url, { headers:{ 'Accept':'application/vnd.github+json', ...(token()?{ 'Authorization':`token ${token()}` }:{}) }});
  if(!r.ok){ throw new Error(`GitHub LIST ${path} ‚Üí ${r.status}`); }
  return r.json();
}

/* ======== ≈†ABLONY V√ùSLEDN√ùCH STR√ÅNEK ======== */
function pageOverlay(src, kind, mime){
  const media = (kind==='video')
    ? '<video class="v" playsinline><source src="'+src+'" type="'+mime+'"></video>'
    : '<audio class="a"><source src="'+src+'" type="'+mime+'"></audio>';
  const JS = "const k='"+kind+"';const el=document.querySelector(k==='video'?'.v':'.a');const btn=document.getElementById('btn');btn.addEventListener('click',()=>{el.play();btn.style.display='none';});if(k==='video'){el.addEventListener('pause',()=>btn.style.display='flex');el.addEventListener('play',()=>btn.style.display='none');}el.addEventListener('ended',()=>btn.style.display='flex');";
  return [
    '<!doctype html><html lang="cs"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Media</title>',
    '<style>html,body{height:100%}body{margin:0;background:#000;color:#fff;font:16px system-ui;display:flex;align-items:center;justify-content:center}.wrap{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center}.v{max-width:100%;max-height:100%;object-fit:contain;display:block}.play{position:absolute;width:96px;height:96px;border-radius:50%;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;cursor:pointer}.play:hover{background:rgba(0,0,0,.75)}.play:before{content:"";display:block;margin-left:6px;border-left:30px solid #fff;border-top:18px solid transparent;border-bottom:18px solid transparent}</style></head><body>',
    '<div class="wrap">'+media+'<div class="play" id="btn"></div></div>',
    '<'+'script>'+JS+'<'+'/script>',
    '</body></html>'
  ].join('');
}

function pagePlayer(src, mime){
  // Stabilnƒõ: nativn√≠ ovladaƒçe + fullscreen p≈ôes nativn√≠ tlaƒç√≠tko
  return '<!doctype html><html lang="cs"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Video</title><style>html,body{height:100%}body{margin:0;background:#000}video{width:100vw;height:100vh;object-fit:contain;display:block;background:#000}</style></head><body><video controls playsinline preload="metadata"><source src="'+src+'" type="'+mime+'"></video></body></html>';
}

function pageAudio(src, mime){
  return '<!doctype html><html lang="cs"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Audio</title><style>body{margin:0;background:#0b1220;color:#e5f0ff;display:flex;align-items:center;justify-content:center;min-height:100vh}audio{width:min(800px,90vw)}</style></head><body><audio controls preload="metadata"><source src="'+src+'" type="'+mime+'"></audio></body></html>';
}

function pageBgVideo(src, fit, loop, bgColor){
  const fitCss = (fit==='cover') ? 'cover' : 'contain';
  const bg = /^#([0-9a-f]{3}){1,2}$/i.test(bgColor||'') ? bgColor : '#000000';
  return '<!doctype html><html lang="cs"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Background</title><style>html,body{height:100%}body{margin:0;background:'+bg+';overflow:hidden}video{position:fixed;inset:0;width:100vw;height:100vh;object-fit:'+fitCss+';object-position:center center;display:block;background:'+bg+'}</style></head><body><video autoplay muted playsinline '+(loop?'loop':'')+'><source src="'+src+'"></video></body></html>';
}

/* ======== UI ======== */
function syncBgOptions(){
  const mode = (document.querySelector('input[name="mode"]:checked')?.value)||'controls';
  const o = $("bgOptions"); o.style.display = mode==='bg-video' ? 'flex' : 'none';
  const fit = (document.querySelector('input[name="bgFit"]:checked')?.value)||'contain';
  $("bgColorWrap").style.display = (mode==='bg-video' && fit==='contain') ? 'flex' : 'none';
}

function addItem({ name, url, when }){
  const box = $("items");
  const el = document.createElement('div');
  el.className = 'item';
  el.innerHTML = `<div><a href="${url}" target="_blank" rel="noopener">${name}</a><div><small>${when? when+' ¬∑ ' : ''}${url}</small></div></div>
  <div><button class="ghost" type="button" onclick="navigator.clipboard.writeText('${url}').then(()=>{this.textContent='Zkop√≠rov√°no'; setTimeout(()=>this.textContent='Kop√≠rovat odkaz',1200);})">Kop√≠rovat odkaz</button></div>`;
  box.prepend(el);
}

async function doList(){
  clearLog();
  try{
    log('üìÑ Naƒç√≠t√°m seznam str√°nek‚Ä¶');
    const items = await ghList({ path: FOLDER_PAGES });
    const htmls = items.filter(x=>x.type==='file' && x.name.endsWith('.html'));
    $("items").innerHTML='';
    if(!htmls.length){ log('≈Ω√°dn√© str√°nky zat√≠m nejsou.'); return; }
    htmls.sort((a,b)=> a.name.localeCompare(b.name)).reverse().forEach(x=>{
      const url = baseUrl()+FOLDER_PAGES+'/'+x.name;
      addItem({ name:x.name, url, when:'' });
    });
    log(`<strong class="ok">‚úì Nalezeno ${htmls.length} str√°nek.</strong>`);
  }catch(e){ log(`‚ö†Ô∏è Chyba: ${e.message}`, 'err'); }
}

async function run(){
  clearLog();
  try{
    const file = $("file").files[0];
    if(!file) throw new Error('Vyber soubor (video/audio).');
    if(file.size > GH_SIZE_LIMIT_MB*1024*1024) throw new Error(`Soubor je vƒõt≈°√≠ ne≈æ ${GH_SIZE_LIMIT_MB} MB.`);

    const title = $("title").value.trim() || file.name.replace(/\.[^.]+$/,'');
    const mode = (document.querySelector('input[name="mode"]:checked')?.value)||'controls';
    const fit  = (document.querySelector('input[name="bgFit"]:checked')?.value)||'contain';
    const loop = $("bgLoop").checked;
    const bgColor = $("bgColor").value || '#000000';

    const kind = kindOf(file);
    if(!kind) throw new Error('Nezn√°m√Ω typ ‚Äì pou≈æij video/* nebo audio/*.');
    if(mode==='bg-video' && kind!=='video') throw new Error('Re≈æim Background video je jen pro video soubory.');

    if(needToken()){ pendingAction=run; openAuth(); log('Je pot≈ôeba vlo≈æit GitHub token (PAT).'); return; }

    const slug=slugify(title)+'-'+nowStamp();
    const ext=(file.name.split('.').pop()||'').toLowerCase();
    const uploadName=`${slug}.${ext || (kind==='video'?'mp4':'mp3')}`;
    const mediaPath=`${FOLDER_UPLOADS}/${uploadName}`;
    const pagePath =`${FOLDER_PAGES}/${slug}.html`;

    log(`Repo: <strong>${GH_OWNER}/${GH_REPO}</strong> ¬∑ vƒõtev <strong>${GH_BRANCH}</strong>`);
    log(`üì¶ Nahr√°v√°m: <strong>${file.name}</strong> ‚Üí <span class="mono">${mediaPath}</span>`);

    const fileB64 = await fileToBase64(file);
    await ghPut({ path:mediaPath, contentBase64:fileB64, message:`Add media: ${uploadName}` });
    log('<strong class="ok">‚úì Soubor nahr√°n.</strong>');

    const rel = `../${mediaPath.replace(/^\/+/, '')}`;
    const mime = mimeOf(file);
    let html;
    if(mode==='overlay')      html = pageOverlay(rel, kind, mime);
    else if(mode==='bg-video')html = pageBgVideo(rel, fit, loop, bgColor);
    else                      html = (kind==='video') ? pagePlayer(rel, mime) : pageAudio(rel, mime);

    await ghPut({ path:pagePath, contentBase64:utf8ToB64(html), message:`Create player page: ${slug}.html` });
    log('<strong class="ok">‚úì Str√°nka vytvo≈ôena.</strong>');

    const url = baseUrl()+pagePath;
    log(`üîó Odkaz: <strong><a target="_blank" rel="noopener" href="${url}">${url}</a></strong>`);
    addItem({ name:`${slug}.html`, url, when:new Date().toLocaleString() });
  }catch(e){ console.error(e); log(`‚ö†Ô∏è Chyba: ${e.message}`, 'err'); }
}

let pendingAction=null;
$("go").addEventListener('click',(e)=>{e.preventDefault();run();});
$("list").addEventListener('click',(e)=>{e.preventDefault();doList();});
$("savePat").addEventListener('click',()=>{const v=$("patInput").value.trim(); if(!v){alert('Vlo≈æ token.');return;} localStorage.setItem(LS_TOKEN_KEY,v); $("patInput").value=''; closeAuth(); if(typeof pendingAction==='function'){const fn=pendingAction; pendingAction=null; fn();}});
$("cancelPat").addEventListener('click',()=>{closeAuth(); pendingAction=null;});

function init(){ if(location.search.includes('logout')) localStorage.removeItem(LS_TOKEN_KEY); if(location.hash==='#token' || needToken()) openAuth(); document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change',syncBgOptions)); document.querySelectorAll('input[name="bgFit"]').forEach(r=>r.addEventListener('change',syncBgOptions)); syncBgOptions(); doList(); }
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
